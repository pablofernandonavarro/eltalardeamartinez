<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de C√°mara</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #333;
            border-radius: 8px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üé• Test de Acceso a la C√°mara</h1>

    <div id="status" class="status info">
        <strong>Estado:</strong> Esperando...
    </div>

    <div id="urlInfo" class="status info">
        <strong>URL actual:</strong> <span id="currentUrl"></span><br>
        <strong>Protocolo:</strong> <span id="protocol"></span><br>
        <strong>¬øEs seguro?:</strong> <span id="isSecure"></span>
    </div>

    <button onclick="testCamera()">üé• Probar C√°mara</button>
    <button onclick="checkPermissions()">üîê Verificar Permisos</button>

    <div style="margin-top: 20px;">
        <video id="video" autoplay playsinline style="display: none;"></video>
    </div>

    <div id="permissionStatus" style="margin-top: 20px;"></div>

    <script>
        // Mostrar info de URL
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('protocol').textContent = window.location.protocol;

        const isSecureContext = window.isSecureContext;
        const isLocalhost = window.location.hostname === 'localhost' ||
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname === '[::1]';

        document.getElementById('isSecure').innerHTML =
            isSecureContext ?
            '<span style="color: green;">‚úÖ S√ç (HTTPS o localhost)</span>' :
            '<span style="color: red;">‚ùå NO - Requiere HTTPS</span>';

        async function checkPermissions() {
            const permDiv = document.getElementById('permissionStatus');
            permDiv.innerHTML = '<h3>Verificando permisos...</h3>';

            try {
                const result = await navigator.permissions.query({ name: 'camera' });
                permDiv.innerHTML = `
                    <div class="status ${result.state === 'granted' ? 'success' : 'error'}">
                        <strong>Estado del permiso de c√°mara:</strong> ${result.state}<br>
                        ${result.state === 'granted' ? '‚úÖ Permiso concedido' : ''}
                        ${result.state === 'denied' ? '‚ùå Permiso denegado - Debes habilitarlo en configuraci√≥n del navegador' : ''}
                        ${result.state === 'prompt' ? '‚ö†Ô∏è Se solicitar√° permiso al usar la c√°mara' : ''}
                    </div>
                `;
            } catch (error) {
                permDiv.innerHTML = `
                    <div class="status error">
                        <strong>Error al verificar permisos:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function testCamera() {
            const status = document.getElementById('status');
            const video = document.getElementById('video');

            status.className = 'status info';
            status.innerHTML = '<strong>Estado:</strong> Solicitando acceso a la c√°mara...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });

                video.srcObject = stream;
                video.style.display = 'block';

                status.className = 'status success';
                status.innerHTML = `
                    <strong>‚úÖ ¬°√âXITO!</strong><br>
                    La c√°mara est√° funcionando correctamente.<br>
                    El problema del scanner es otro (probablemente la librer√≠a Html5Qrcode).
                `;

            } catch (error) {
                status.className = 'status error';

                let mensaje = '';
                if (error.name === 'NotAllowedError') {
                    mensaje = `
                        <strong>‚ùå Permiso denegado</strong><br>
                        El usuario rechaz√≥ el acceso a la c√°mara.<br>
                        <strong>Soluci√≥n:</strong> Haz clic en el √≠cono de c√°mara en la barra de direcciones y permite el acceso.
                    `;
                } else if (error.name === 'NotFoundError') {
                    mensaje = `
                        <strong>‚ùå C√°mara no encontrada</strong><br>
                        No se detect√≥ ninguna c√°mara en el dispositivo.
                    `;
                } else if (error.name === 'NotSupportedError') {
                    mensaje = `
                        <strong>‚ùå No soportado</strong><br>
                        ${!isSecureContext ?
                            '<strong>PROBLEMA:</strong> Debes usar HTTPS o localhost.<br>' +
                            '<strong>URL actual:</strong> ' + window.location.href + '<br>' +
                            '<strong>Soluci√≥n:</strong> Accede usando http://localhost o http://127.0.0.1'
                            : 'El navegador no soporta acceso a la c√°mara.'}
                    `;
                } else {
                    mensaje = `
                        <strong>‚ùå Error: ${error.name}</strong><br>
                        ${error.message}
                    `;
                }

                status.innerHTML = mensaje;
            }
        }

        // Auto-ejecutar verificaci√≥n al cargar
        window.addEventListener('load', () => {
            checkPermissions();
        });
    </script>
</body>
</html>
